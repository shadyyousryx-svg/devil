<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±ÙƒØ© - Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <meta name="theme-color" content="#d32f2f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„ØªØ«Ø¨ÙŠØª PWA -->
    <link rel="manifest" href="manifest.json">

    <link rel="icon" type="image/jpeg" href="https://i.ibb.co/bRzWVmPC/logo.jpg">
    <link rel="apple-touch-icon" href="https://i.ibb.co/bRzWVmPC/logo.jpg">

    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (For modern UI icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        primary: '#d32f2f', // Main Red
                        secondary: '#ffc107', // Yellow
                        darkBg: '#121212',
                        darkCard: '#1e1e1e'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbars & Utilities */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism effects */
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass-nav { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); }
        
        /* Splash Screen BG */
        .splash-bg {
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://i.ibb.co/HTWhBfwz/Untitled-Project-7.jpg');
            background-size: cover; background-position: center;
        }

        /* Animations */
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; transform: translateY(15px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Drawer/Modal Transition */
        .drawer-overlay { transition: opacity 0.3s ease; }
        .drawer-content { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-darkBg dark:text-gray-200 antialiased transition-colors duration-300">

    <!-- 1. Splash / Home Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] splash-bg flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="animate-bounce mb-6">
            <img src="https://i.ibb.co/bRzWVmPC/logo.jpg" class="w-32 h-32 rounded-full border-4 border-secondary object-cover shadow-2xl bg-white">
        </div>
        <h1 class="text-4xl font-bold mb-2 text-shadow-lg">Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±ÙƒØ©</h1>
        <p class="text-gray-300 text-sm mb-8">ğŸ“ Ø§Ù„Ø®ÙˆØ¶ | Ø§Ù„Ø®ÙˆÙŠØ±</p>
        
        <div id="status-tag" class="bg-secondary text-black px-6 py-2 rounded-full font-bold text-sm mb-6 animate-pulse">
            Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ â³...
        </div>
        
        <button id="start-btn" onclick="startApp()" disabled class="bg-primary hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-10 py-4 rounded-full font-bold text-lg shadow-[0_0_15px_rgba(211,47,47,0.5)] transition-all transform active:scale-95 flex items-center gap-2">
            <i class="ph ph-spinner-gap animate-spin text-xl hidden" id="loading-icon"></i>
            <span id="start-text">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</span>
        </button>
    </div>

    <!-- 2. Main App Content (Hidden initially) -->
    <div id="main-app" class="hidden pb-24">
        
        <!-- Header & Nav -->
        <header class="sticky top-0 z-40 glass-nav border-b border-gray-200 dark:border-gray-800 shadow-sm">
            <div class="px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://i.ibb.co/bRzWVmPC/logo.jpg" class="w-10 h-10 rounded-full border-2 border-primary object-cover">
                    <div>
                        <h2 class="font-bold text-lg leading-tight dark:text-white">Ø§Ù„Ø¨Ø±ÙƒØ©</h2>
                        <span class="text-[10px] text-primary font-bold bg-red-100 dark:bg-red-900/30 px-2 py-0.5 rounded-full">Ø§Ø³ØªÙ„Ø§Ù… ÙÙ‚Ø·</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleDarkMode()" class="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition">
                        <i class="ph ph-moon text-xl dark:hidden"></i>
                        <i class="ph ph-sun text-xl hidden dark:block"></i>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="px-4 pb-3">
                <div class="relative">
                    <input type="text" id="searchInput" oninput="filterMenu()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ø¨ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©..." 
                        class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-2xl py-3 pr-11 pl-4 text-sm focus:ring-2 focus:ring-primary dark:text-white transition">
                    <i class="ph ph-magnifying-glass absolute right-4 top-3.5 text-gray-400 text-lg"></i>
                </div>
            </div>

            <!-- Categories Tabs -->
            <div class="flex overflow-x-auto hide-scrollbar gap-2 px-4 pb-3" id="cat-tabs">
                <!-- Injected via JS -->
            </div>
        </header>

        <!-- Menu Grid -->
        <main class="p-4">
            <div id="items-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Items injected via JS -->
            </div>
            
            <!-- Empty State for Search -->
            <div id="empty-search" class="hidden flex-col items-center justify-center py-12 text-gray-400">
                <i class="ph ph-magnifying-glass text-5xl mb-3 opacity-50"></i>
                <p class="font-bold">Ù„Ù… Ù†Ø¬Ø¯ Ù…Ø§ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡!</p>
            </div>
        </main>
    </div>

    <!-- 3. Floating Cart Button (Bottom) -->
    <div id="fab-cart" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 hidden transition-transform duration-300">
        <button onclick="openCart()" class="bg-primary text-white px-6 py-3.5 rounded-full shadow-xl shadow-red-500/30 font-bold flex items-center gap-3 hover:bg-red-700 transition active:scale-95">
            <div class="relative">
                <i class="ph ph-shopping-cart text-2xl"></i>
                <span id="fab-count" class="absolute -top-2 -right-2 bg-secondary text-black text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-black border-2 border-primary border-solid">0</span>
            </div>
            <span>Ø¹Ù€Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</span>
            <span class="text-red-200 text-sm">|</span>
            <span id="fab-total" class="font-black text-secondary">0.000 Ø±.Ø¹</span>
        </button>
    </div>

    <!-- 4. Item Options Modal (Bottom Sheet) -->
    <div id="item-modal" class="fixed inset-0 z-50 hidden">
        <div class="drawer-overlay absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0" onclick="closeItemModal()"></div>
        <div class="drawer-content absolute bottom-0 left-0 right-0 bg-white dark:bg-darkCard rounded-t-3xl translate-y-full opacity-0 max-h-[90vh] flex flex-col shadow-2xl sm:max-w-md sm:mx-auto">
            
            <div class="flex justify-between items-center p-5 border-b border-gray-100 dark:border-gray-800">
                <h3 id="modal-title" class="font-bold text-lg dark:text-white">ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ¬Ø¨Ø©</h3>
                <button onclick="closeItemModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-full text-gray-600 dark:text-gray-300"><i class="ph ph-x"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto hide-scrollbar flex-1 space-y-5" id="options-render">
                <!-- Options injected here -->
            </div>
            
            <div class="p-5 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-darkCard/80">
                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-white dark:bg-gray-800 rounded-xl p-1 border border-gray-200 dark:border-gray-700">
                        <button onclick="changeOptQty(-1)" class="w-10 h-10 flex items-center justify-center text-lg font-bold text-gray-600 dark:text-gray-300">-</button>
                        <span id="opt-qty-val" class="w-8 text-center font-bold text-lg dark:text-white">1</span>
                        <button onclick="changeOptQty(1)" class="w-10 h-10 flex items-center justify-center text-lg font-bold text-primary">+</button>
                    </div>
                    <button onclick="addItemToCart()" class="flex-1 bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                        <span>Ø¥Ø¶Ø§ÙØ©</span>
                        <span class="text-sm opacity-80">| <span id="modal-price-total">0.000</span> Ø±.Ø¹</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Cart & Checkout Drawer -->
    <div id="cart-drawer" class="fixed inset-0 z-50 hidden">
        <div class="drawer-overlay absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0" onclick="closeCart()"></div>
        <div class="drawer-content absolute top-0 bottom-0 left-0 w-full sm:max-w-md bg-white dark:bg-darkCard -translate-x-full opacity-0 flex flex-col shadow-2xl">
            
            <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-800 bg-primary text-white">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="ph ph-shopping-bag"></i> Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                <button onclick="closeCart()" class="text-white/80 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-darkBg">
                <!-- Info Alert -->
                <div class="bg-red-50 dark:bg-red-900/20 border border-primary/30 rounded-xl p-3 mb-5 flex gap-3 text-sm">
                    <i class="ph ph-info text-primary text-lg flex-shrink-0 mt-0.5"></i>
                    <p class="text-primary dark:text-red-400 font-semibold">Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø®ØµØµ Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·.</p>
                </div>

                <!-- Cart Items -->
                <div id="cart-display" class="space-y-3 mb-6">
                    <!-- Items -->
                </div>

                <!-- Checkout Form -->
                <div id="checkout-form" class="space-y-4 bg-white dark:bg-darkCard p-4 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hidden">
                    <h3 class="font-bold text-gray-800 dark:text-white border-b border-gray-100 dark:border-gray-800 pb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h3>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙŠÙ…</label>
                        <input type="text" id="customer-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-primary dark:text-white outline-none">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">ÙØ±Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
                        <select id="branch-select" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-primary dark:text-white outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹...</option>
                            <option value="ÙØ±Ø¹ Ø§Ù„Ø®ÙˆØ¶ - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¨Ø±ÙƒØ§Øª">Ø§Ù„Ø®ÙˆØ¶ - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¨Ø±ÙƒØ§Øª</option>
                            <option value="ÙØ±Ø¹ Ø§Ù„Ø®ÙˆÙŠØ± - Ø´Ø§Ø±Ø¹ Ø³ÙˆÙ‚ Ø§Ù„Ø®ÙˆÙŠØ±">Ø§Ù„Ø®ÙˆÙŠØ± - Ø³ÙˆÙ‚ Ø§Ù„Ø®ÙˆÙŠØ±</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
                        <div class="flex gap-2 bg-gray-50 dark:bg-gray-800 p-1 rounded-xl border border-gray-200 dark:border-gray-700">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="pickup-time-type" value="asap" checked onchange="toggleTimeInput()" class="peer sr-only">
                                <div class="py-1.5 text-xs font-bold rounded-lg text-gray-500 peer-checked:bg-white dark:peer-checked:bg-darkCard peer-checked:text-primary peer-checked:shadow-sm transition">Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª (<span id="asap-time-span">20</span>Ø¯)</div>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="pickup-time-type" value="scheduled" onchange="toggleTimeInput()" class="peer sr-only">
                                <div class="py-1.5 text-xs font-bold rounded-lg text-gray-500 peer-checked:bg-white dark:peer-checked:bg-darkCard peer-checked:text-primary peer-checked:shadow-sm transition">ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª</div>
                            </label>
                        </div>
                        <select id="scheduled-time-select" class="w-full mt-2 bg-white dark:bg-darkBg border border-primary text-primary rounded-xl px-3 py-2 text-sm hidden font-bold outline-none"></select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø±Ù‚Ù…/Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©)</label>
                        <textarea id="pickup-notes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ..." class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-primary dark:text-white outline-none resize-none"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-white dark:bg-darkCard border-t border-gray-200 dark:border-gray-800 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-500 font-bold text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
                    <span class="text-2xl font-black text-primary"><span id="total-val">0.000</span> Ø±.Ø¹</span>
                </div>
                <button id="btn-submit-order" onclick="submitOrder()" disabled class="w-full bg-[#25D366] disabled:bg-gray-400 hover:bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                    <i class="ph ph-whatsapp-logo text-2xl"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨
                </button>
            </div>
        </div>
    </div>

    <!-- Toasts Container -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[70] flex flex-col gap-2 pointer-events-none w-[90%] sm:w-auto text-center"></div>

    <script>
        // --- Configuration & Variables ---
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_mLvfHoHl4JY7Njpl7mfVL1gXbhg_tBbGyi-NWLacXPmRmPornWAg7bqDBGdNya2Ky_haLSvuBD6j/pub?output=csv";
        
        let deliveryTime = "20"; 
        let whatsappNumber = "96892018510";
        let openingTime = "00:00"; 
        let closingTime = "23:59"; 

        const saucesUI = `
            <option value="ØµÙˆØµ Ø±Ø§Ù†Ø´">ØµÙˆØµ Ø±Ø§Ù†Ø´</option>
            <option value="ØµÙˆØµ Ø¨Ø§Ø±Ø¨ÙŠÙƒÙˆ">ØµÙˆØµ Ø¨Ø§Ø±Ø¨ÙŠÙƒÙˆ</option>
            <option value="ØµÙˆØµ ÙƒÙˆÙƒØªÙŠÙ„">ØµÙˆØµ ÙƒÙˆÙƒØªÙŠÙ„</option>
            <option value="ØµÙˆØµ Ø­Ø§Ø±">ØµÙˆØµ Ø­Ø§Ø±</option>
            <option value="ØµÙˆØµ Ø³ÙˆÙŠØª Ø´ÙŠÙ„ÙŠ">ØµÙˆØµ Ø³ÙˆÙŠØª Ø´ÙŠÙ„ÙŠ</option>
            <option value="ØµÙˆØµ Ø«ÙˆÙ…ÙŠÙ‡">ØµÙˆØµ Ø«ÙˆÙ…ÙŠÙ‡</option>
            <option value="Ø­Ù„Ù‚Ø§Øª Ù‡Ø§Ù„Ø¨ÙŠÙ†Ùˆ">Ø­Ù„Ù‚Ø§Øª Ù‡Ø§Ù„Ø¨ÙŠÙ†Ùˆ</option>
        `;
        
        const drinksUI = `
            <option value="Ø§Ù„Ø³ÙŠ ÙƒÙˆÙ„Ø§">Ø§Ù„Ø³ÙŠ ÙƒÙˆÙ„Ø§</option>
            <option value="Ø§Ù„Ø³ÙŠ ØªÙØ§Ø­">Ø§Ù„Ø³ÙŠ ØªÙØ§Ø­</option>
            <option value="Ø§Ù„Ø³ÙŠ ÙƒÙˆÙ„Ø§ Ø¯Ø§ÙŠØª">Ø§Ù„Ø³ÙŠ ÙƒÙˆÙ„Ø§ Ø¯Ø§ÙŠØª</option>
            <option value="Ø§Ù„Ø³ÙŠ Ù„ÙŠÙ…ÙˆÙ†">Ø§Ù„Ø³ÙŠ Ù„ÙŠÙ…ÙˆÙ†</option>
            <option value="Ø§Ù„Ø³ÙŠ Ø³ØªØ±ÙŠÙ…">Ø§Ù„Ø³ÙŠ Ø³ØªØ±ÙŠÙ…</option>
            <option value="Ø§Ù„Ø³ÙŠ Ø¨Ø±ØªÙ‚Ø§Ù„">Ø§Ù„Ø³ÙŠ Ø¨Ø±ØªÙ‚Ø§Ù„</option>
            <option value="Ø§Ù„Ø³ÙŠ Ø­Ù…Ø¶ÙŠØ§Øª">Ø§Ù„Ø³ÙŠ Ø­Ù…Ø¶ÙŠØ§Øª</option>
        `;

        let menuData = {};
        let allItemsFlat = []; // For search
        let cart = [];
        let selectedItem = null;
        let currentOptQty = 1;
        let currentCategory = ""; 

        // --- Core Functions ---
        
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-gray-900 dark:bg-white text-white dark:text-black' : 'bg-red-500 text-white';
            toast.className = `${bg} px-4 py-3 rounded-xl shadow-lg font-bold text-sm transform transition-all duration-300 translate-y-10 opacity-0 flex items-center justify-center gap-2`;
            toast.innerHTML = type === 'success' ? `<i class="ph ph-check-circle text-lg text-green-400 dark:text-green-600"></i> ${msg}` : `<i class="ph ph-warning-circle text-lg"></i> ${msg}`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // Init theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function isRestaurantOpen() {
            if (!openingTime || !closingTime) return true;
            
            // Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù„ÙŠÙƒÙˆÙ† Ø¨ØªÙˆÙ‚ÙŠØª Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† (Ù…Ø³Ù‚Ø·)
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Muscat"}));
            const currentTotal = now.getHours() * 60 + now.getMinutes();
            try {
                const [oH, oM] = openingTime.split(':').map(Number);
                const [cH, cM] = closingTime.split(':').map(Number);
                const oTot = oH * 60 + oM, cTot = cH * 60 + cM;
                if (oTot < cTot) return currentTotal >= oTot && currentTotal <= cTot;
                else return currentTotal >= oTot || currentTotal <= cTot;
            } catch (e) { return true; }
        }

        function formatTimeAMPM(time24) {
            const [h, m] = time24.split(':');
            let hours = parseInt(h);
            const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
            hours = hours % 12 || 12;
            return `${hours}:${m} ${ampm}`;
        }

        async function fetchMenuData() {
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                const rows = csvText.split('\n').map(r => r.trim()).filter(r => r);
                
                for(let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    if(cols.length < 3) continue;

                    let cat = cols[0];
                    let name = cols[1];
                    let price = parseFloat(cols[2].replace(/[^\d.]/g, '')) || 0;

                    if (cat === "Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª") {
                        if (name === "Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨") whatsappNumber = cols[2];
                        if (name === "ÙˆÙ‚Øª Ø§Ù„ÙØªØ­") openingTime = cols[2].trim();
                        if (name === "ÙˆÙ‚Øª Ø§Ù„ØºÙ„Ù‚") closingTime = cols[2].trim();
                        if (name === "ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" || name === "ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„") {
                            deliveryTime = cols[2].replace(/[^\d]/g, '') || "20"; 
                            document.getElementById('asap-time-span').innerText = deliveryTime;
                        }
                        continue;
                    }

                    if (cat === "Ø¬Ø¨Ù† Ø§Ø¶Ø§ÙÙŠ") continue;

                    const mergedCats = ["Ù…Ø´Ø±ÙˆØ¨Ø§Øª", "Ø¨Ø§ÙƒØª Ø´ÙŠØ¨Ø³", "ÙƒÙˆÙ…Ø¨Ùˆ", "Ù…ÙŠØ§Ù‡", "Ø®Ø¨Ø²", "Ø¥Ø¶Ø§ÙØ§Øª", "ØµÙˆØµØ§Øª"];
                    if (mergedCats.includes(cat)) cat = "Ø§Ø¶Ø§ÙØ§Øª ÙˆØ¬Ø¨Ø§Øª";
                    
                    let img = cols[3] ? cols[3].replace(/[\[\]]/g, '') : '';
                    if(name.includes("Ù‚Ø·Ø¹Ø© Ø§Ø³ØªØ±ÙŠØ¨Ø³")) img = "https://i.ibb.co/Vph8WY44/mmw-638669571739251392.webp";

                    let flv = cols[4] === 'Ù†Ø¹Ù…';
                    let s = parseInt(cols[5]) || 0;
                    let d = parseInt(cols[6]) || 0;

                    if(name.includes("ØµÙˆØµØ§Øª Ù…ØªÙ†ÙˆØ¹Ø©")) s = Math.max(s, 1);
                    if(name.includes("ÙƒÙˆÙ…Ø¨Ùˆ") || name.includes("Ù…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©")) d = Math.max(d, 1); 

                    const itemObj = { id: i, name, price, img, flv, s, d, catOrigin: cat };
                    
                    if(!menuData[cat]) menuData[cat] = [];
                    menuData[cat].push(itemObj);
                    allItemsFlat.push(itemObj);
                }

                setupStartButton();

            } catch(e) {
                console.error(e);
                document.getElementById('status-tag').innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
                document.getElementById('status-tag').className = "bg-red-500 text-white px-6 py-2 rounded-full font-bold text-sm mb-6";
            }
        }

        function setupStartButton() {
            const btn = document.getElementById('start-btn');
            const statusTag = document.getElementById('status-tag');
            const startText = document.getElementById('start-text');
            const loadIcon = document.getElementById('loading-icon');
            
            statusTag.classList.remove('animate-pulse');
            
            if (isRestaurantOpen()) {
                startText.innerText = "ØªØµÙØ­ Ø§Ù„Ù…Ù†ÙŠÙˆ ğŸ—";
                btn.disabled = false;
                statusTag.innerText = "Ù…ÙØªÙˆØ­ - Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… ÙÙ‚Ø·";
                statusTag.className = "bg-green-500 text-white px-6 py-2 rounded-full font-bold text-sm mb-6";
            } else {
                startText.innerText = "Ø§Ù„Ù…Ø·Ø¹Ù… Ù…ØºÙ„Ù‚";
                btn.disabled = true;
                const openAMPM = formatTimeAMPM(openingTime);
                const closeAMPM = formatTimeAMPM(closingTime);
                statusTag.innerText = `Ù…ØºÙ„Ù‚ (Ù…Ù† ${openAMPM} Ø¥Ù„Ù‰ ${closeAMPM})`;
                statusTag.className = "bg-red-500 text-white px-6 py-2 rounded-full font-bold text-sm mb-6";
            }
        }

        function startApp() {
            document.getElementById('splash-screen').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('main-app').classList.remove('hidden');
                
                renderTabs();
                if(!currentCategory) currentCategory = Object.keys(menuData)[0];
                showCategory(currentCategory);
            }, 500);
        }

        // --- UI Rendering ---

        function renderTabs() {
            const tabs = document.getElementById('cat-tabs');
            tabs.innerHTML = '';
            
            tabs.innerHTML += `<button class="cat-tab px-5 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-bold whitespace-nowrap transition-colors bg-white dark:bg-darkCard text-gray-600 dark:text-gray-300" onclick="showCategory('all', this)">Ø§Ù„ÙƒÙ„</button>`;

            Object.keys(menuData).forEach((cat) => {
                tabs.innerHTML += `<button class="cat-tab px-5 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-bold whitespace-nowrap transition-colors bg-white dark:bg-darkCard text-gray-600 dark:text-gray-300" onclick="showCategory('${cat}', this)">${cat}</button>`;
            });

            // Set active class on first load
            setTimeout(() => {
                const defaultBtn = [...document.querySelectorAll('.cat-tab')].find(b => b.innerText === currentCategory) || document.querySelectorAll('.cat-tab')[0];
                if(defaultBtn) setActiveTab(defaultBtn);
            }, 50);
        }

        function setActiveTab(btn) {
            document.querySelectorAll('.cat-tab').forEach(t => {
                t.classList.remove('bg-primary', 'text-white', 'border-primary');
                t.classList.add('bg-white', 'dark:bg-darkCard', 'text-gray-600', 'dark:text-gray-300', 'border-gray-200', 'dark:border-gray-700');
            });
            if(btn) {
                btn.classList.remove('bg-white', 'dark:bg-darkCard', 'text-gray-600', 'dark:text-gray-300', 'border-gray-200', 'dark:border-gray-700');
                btn.classList.add('bg-primary', 'text-white', 'border-primary');
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function showCategory(cat, btn = null) {
            currentCategory = cat;
            if(btn) setActiveTab(btn);
            document.getElementById('searchInput').value = ''; // clear search
            renderItems(cat === 'all' ? allItemsFlat : menuData[cat]);
        }

        function filterMenu() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('bg-primary', 'text-white')); // visual cue that we are searching
            
            let filtered = allItemsFlat.filter(i => i.name.toLowerCase().includes(query));
            renderItems(filtered);
        }

        function renderItems(items) {
            const list = document.getElementById('items-list');
            const empty = document.getElementById('empty-search');
            list.innerHTML = '';
            
            if(!items || items.length === 0) {
                empty.classList.remove('hidden');
                empty.classList.add('flex');
                return;
            }
            empty.classList.add('hidden');
            empty.classList.remove('flex');

            items.forEach((item, idx) => {
                list.innerHTML += `
                    <div class="bg-white dark:bg-darkCard rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-3 flex gap-3 cursor-pointer active:scale-95 transition-transform fade-in-up" style="animation-delay: ${idx * 0.03}s" onclick='initOptions(${JSON.stringify(item)})'>
                        <img src="${item.img || 'https://via.placeholder.com/100?text=Baraka'}" onerror="this.src='https://via.placeholder.com/100?text=Baraka'" class="w-24 h-24 object-cover rounded-xl bg-gray-100 dark:bg-gray-800">
                        <div class="flex-1 flex flex-col justify-center">
                            <h3 class="font-bold text-sm text-gray-900 dark:text-white leading-tight mb-2">${item.name}</h3>
                            <div class="flex justify-between items-center mt-auto">
                                <span class="font-black text-primary text-sm">${item.price.toFixed(3)} Ø±.Ø¹</span>
                                <button class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 text-primary flex items-center justify-center"><i class="ph ph-plus font-bold"></i></button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        // --- Modals & Drawers ---

        function initOptions(item) {
            selectedItem = item;
            currentOptQty = 1;
            document.getElementById('opt-qty-val').innerText = currentOptQty;
            document.getElementById('modal-title').innerText = item.name;
            updateModalPrice();
            
            let html = ``;
            const boxClass = `bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700`;
            const labelClass = `block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2`;
            const selectClass = `w-full bg-white dark:bg-darkBg border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary dark:text-white outline-none`;

            if(item.flv) {
                html += `<div class="${boxClass}">
                    <label class="${labelClass}">ğŸŒ¶ï¸ Ø§Ù„Ø·Ø¹Ù…</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="sel-flv" value="Ø¹Ø§Ø¯ÙŠ" checked class="peer sr-only">
                            <div class="text-center py-2 px-3 rounded-lg border border-gray-200 dark:border-gray-600 peer-checked:border-primary peer-checked:bg-red-50 dark:peer-checked:bg-red-900/20 peer-checked:text-primary transition font-bold text-sm dark:text-gray-300">Ø¹Ø§Ø¯ÙŠ</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="sel-flv" value="Ø­Ø§Ø±" class="peer sr-only">
                            <div class="text-center py-2 px-3 rounded-lg border border-gray-200 dark:border-gray-600 peer-checked:border-primary peer-checked:bg-red-50 dark:peer-checked:bg-red-900/20 peer-checked:text-primary transition font-bold text-sm dark:text-gray-300">Ø­Ø§Ø± ğŸŒ¶ï¸</div>
                        </label>
                    </div>
                </div>`;
            }
            
            if(item.name.includes("ØªÙˆØ³ØªØ±") || item.name.includes("ØªØ±Ø¨Ù„ ØªÙˆØ³ØªØ±")) {
                html += `<div class="${boxClass} border-secondary">
                    <label class="${labelClass}">ğŸ§€ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¨Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select id="sel-cheese" onchange="updateModalPrice()" class="${selectClass}">
                        <option value="0">Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ©</option>
                        <option value="0.100">Ø´Ø±ÙŠØ­Ø© Ø¬Ø¨Ù† (+0.100 Ø±.Ø¹)</option>
                        <option value="0.200">Ø´Ø±ÙŠØ­ØªÙŠÙ† Ø¬Ø¨Ù† (+0.200 Ø±.Ø¹)</option>
                        <option value="0.300">3 Ø´Ø±Ø§Ø¦Ø­ Ø¬Ø¨Ù† (+0.300 Ø±.Ø¹)</option>
                    </select>
                </div>`;
            }

            if(item.d > 0) {
                for(let i=1; i<=item.d; i++) {
                    html += `<div class="${boxClass}"><label class="${labelClass}">ğŸ¥¤ Ù…Ø´Ø±ÙˆØ¨ ${item.d > 1 ? i : ''}</label><select class="sel-drink ${selectClass}">${drinksUI}</select></div>`;
                }
            }

            if(item.s > 0) {
                for(let i=1; i<=item.s; i++) {
                    html += `<div class="${boxClass}"><label class="${labelClass}">ğŸ§‚ ØµÙˆØµ ${item.s > 1 ? i : ''}</label><select class="sel-sauce ${selectClass}">${saucesUI}</select></div>`;
                }
            }
            
            html += `<div class="${boxClass}">
                <label class="${labelClass}">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© (Ø¨Ø¯ÙˆÙ† Ø·Ù…Ø§Ø·Ù…ØŒ Ø§Ù„Ø®...)</label>
                <textarea id="sel-note" rows="2" class="w-full bg-white dark:bg-darkBg border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary dark:text-white outline-none resize-none"></textarea>
            </div>`;
            
            document.getElementById('options-render').innerHTML = html;
            
            // Open Modal
            const modal = document.getElementById('item-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.drawer-overlay').classList.remove('opacity-0');
                modal.querySelector('.drawer-content').classList.remove('translate-y-full', 'opacity-0');
            }, 10);
        }

        function closeItemModal() {
            const modal = document.getElementById('item-modal');
            modal.querySelector('.drawer-overlay').classList.add('opacity-0');
            modal.querySelector('.drawer-content').classList.add('translate-y-full', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function changeOptQty(change) {
            currentOptQty += change;
            if(currentOptQty < 1) currentOptQty = 1;
            document.getElementById('opt-qty-val').innerText = currentOptQty;
            updateModalPrice();
        }

        function updateModalPrice() {
            if(!selectedItem) return;
            const cheesePrice = parseFloat(document.getElementById('sel-cheese')?.value || 0);
            const total = (selectedItem.price + cheesePrice) * currentOptQty;
            document.getElementById('modal-price-total').innerText = total.toFixed(3);
        }

        // --- Cart Management ---

        function addItemToCart() {
            const cheeseSelect = document.getElementById('sel-cheese');
            const cheesePrice = cheeseSelect ? parseFloat(cheeseSelect.value) : 0;
            const cheeseText = cheeseSelect && cheesePrice > 0 ? cheeseSelect.options[cheeseSelect.selectedIndex].text : '';

            const finalItemPrice = selectedItem.price + cheesePrice;
            const flvRadio = document.querySelector('input[name="sel-flv"]:checked');

            cart.push({
                id: Date.now(), // unique ID for removal
                name: selectedItem.name,
                qty: currentOptQty,
                unitPrice: finalItemPrice,
                totalPrice: finalItemPrice * currentOptQty,
                flv: flvRadio ? flvRadio.value : '',
                cheeseInfo: cheeseText,
                sauces: Array.from(document.querySelectorAll('.sel-sauce')).map(s => s.value),
                drinks: Array.from(document.querySelectorAll('.sel-drink')).map(d => d.value),
                note: document.getElementById('sel-note').value,
                img: selectedItem.img
            });
            
            updateCartUI();
            closeItemModal();
            showToast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ˜‹');

            // Ø¥Ø·Ù„Ø§Ù‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ø­ØªÙØ§Ù„ (Confetti)
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.8 },
                    colors: ['#d32f2f', '#ffc107', '#ffffff'] // Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†Ø§Ø³Ù‚Ø© Ù…Ø¹ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹
                });
            }
        }

        function updateCartUI() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            
            // Update FAB
            const fab = document.getElementById('fab-cart');
            document.getElementById('fab-count').innerText = count;
            document.getElementById('fab-total').innerText = total.toFixed(3) + ' Ø±.Ø¹';
            
            if(count > 0) fab.classList.remove('hidden');
            else fab.classList.add('hidden');

            // Update Drawer logic (if open)
            renderCartItems();
        }

        function openCart() {
            renderCartItems();
            const modal = document.getElementById('cart-drawer');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.drawer-overlay').classList.remove('opacity-0');
                modal.querySelector('.drawer-content').classList.remove('-translate-x-full', 'opacity-0');
            }, 10);
        }

        function closeCart() {
            const modal = document.getElementById('cart-drawer');
            modal.querySelector('.drawer-overlay').classList.add('opacity-0');
            modal.querySelector('.drawer-content').classList.add('-translate-x-full', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderCartItems() {
            const display = document.getElementById('cart-display');
            const form = document.getElementById('checkout-form');
            const submitBtn = document.getElementById('btn-submit-order');
            
            display.innerHTML = '';
            let total = 0;
            
            if(cart.length === 0) {
                display.innerHTML = `<div class="text-center py-10 text-gray-400"><i class="ph ph-shopping-cart text-5xl mb-2 opacity-50"></i><p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p></div>`;
                form.classList.add('hidden');
                submitBtn.disabled = true;
            } else {
                form.classList.remove('hidden');
                submitBtn.disabled = false;
                
                cart.forEach((item) => {
                    total += item.totalPrice;
                    
                    let detailsHTML = '';
                    if(item.flv) detailsHTML += `<span class="bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded text-[10px]">${item.flv}</span>`;
                    if(item.cheeseInfo) detailsHTML += `<span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-500 px-1.5 py-0.5 rounded text-[10px]">ğŸ§€ Ø¬Ø¨Ù†</span>`;
                    if(item.sauces.length) detailsHTML += `<p class="text-[11px] text-gray-500 truncate w-full mt-1">ğŸ§‚ ${item.sauces.join('ØŒ ')}</p>`;
                    if(item.drinks.length) detailsHTML += `<p class="text-[11px] text-gray-500 truncate w-full">ğŸ¥¤ ${item.drinks.join('ØŒ ')}</p>`;
                    if(item.note) detailsHTML += `<p class="text-[11px] text-gray-400 italic mt-1 max-w-[180px] truncate">"${item.note}"</p>`;

                    display.innerHTML += `
                        <div class="bg-white dark:bg-darkCard p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 flex gap-3 relative">
                            <button onclick="removeFromCart(${item.id})" class="absolute top-2 left-2 text-red-400 hover:text-red-600 p-1"><i class="ph ph-trash"></i></button>
                            <img src="${item.img || 'https://via.placeholder.com/60'}" class="w-16 h-16 rounded-xl object-cover bg-gray-100">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm dark:text-white leading-tight pr-6">${item.name}</h4>
                                <div class="flex flex-wrap gap-1 mt-1 mb-2">${detailsHTML}</div>
                                <div class="flex justify-between items-center mt-auto">
                                    <span class="font-bold text-primary text-sm">${item.totalPrice.toFixed(3)} Ø±.Ø¹</span>
                                    <span class="text-xs font-bold bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-lg dark:text-white">Ø§Ù„Ø¹Ø¯Ø¯: ${item.qty}</span>
                                </div>
                            </div>
                        </div>`;
                });
            }
            document.getElementById('total-val').innerText = total.toFixed(3);
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCartUI();
        }

        // --- Checkout & Time ---

        function generateTimeOptions() {
            const select = document.getElementById('scheduled-time-select');
            select.innerHTML = '';
            
            // Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù„ÙŠÙƒÙˆÙ† Ø¨ØªÙˆÙ‚ÙŠØª Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† (Ù…Ø³Ù‚Ø·)
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Muscat"}));
            const [openH, openM] = openingTime.split(':').map(Number);
            const [closeH, closeM] = closingTime.split(':').map(Number);
            
            let openTotal = openH * 60 + openM;
            let closeTotal = closeH * 60 + closeM;
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ù…Ø«Ø§Ù„: ÙŠÙØªØ­ 10 Øµ ÙˆÙŠØºÙ„Ù‚ 2 Øµ)
            if (closeTotal <= openTotal) {
                closeTotal += 24 * 60;
            }
            
            let currentTotal = now.getHours() * 60 + now.getMinutes();
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ ÙˆÙ‚Ø¨Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ)ØŒ Ù†Ø¶ÙŠÙ 24 Ø³Ø§Ø¹Ø© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (currentTotal < openTotal && currentTotal <= closeTotal - (24 * 60)) {
                currentTotal += 24 * 60;
            }

            // ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† ÙˆÙ‚Øª Ø§Ù„ÙØªØ­ Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ + ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø£ÙŠÙ‡Ù…Ø§ Ø£ÙƒØ¨Ø±)
            let prepTime = parseInt(deliveryTime) || 20;
            let startMins = Math.max(openTotal, Math.ceil((currentTotal + prepTime) / 15) * 15); 
            
            let count = 0;
            for(let m = startMins; m <= closeTotal; m += 15) { 
                if (count > 20) break; // Ø¹Ø±Ø¶ 20 Ø®ÙŠØ§Ø± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
                let h = Math.floor(m / 60) % 24;
                let mm = m % 60;
                let timeStr = formatTimeAMPM(`${h}:${mm < 10 ? '0' + mm : mm}`);
                select.innerHTML += `<option value="${timeStr}">${timeStr}</option>`;
                count++;
            }

            if (select.innerHTML === '') {
                select.innerHTML = `<option value="">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‚Ø§Ø±Ø¨ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„ØºÙ„Ù‚ Ø£Ùˆ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</option>`;
            }
        }

        function toggleTimeInput() {
            const type = document.querySelector('input[name="pickup-time-type"]:checked').value;
            const select = document.getElementById('scheduled-time-select');
            if (type === 'scheduled') {
                select.classList.remove('hidden');
                generateTimeOptions();
            } else {
                select.classList.add('hidden');
            }
        }

        function submitOrder() {
            if(!isRestaurantOpen()) {
                showToast(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù†ØªÙ‡Øª Ø£ÙˆÙ‚Ø§Øª Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·Ø¹Ù… Ù„Ù„ØªÙˆ.`, 'error');
                return;
            }

            const custName = document.getElementById('customer-name').value.trim();
            const branch = document.getElementById('branch-select').value;
            
            if(!custName) return showToast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.", 'error');
            if(!branch) return showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù….", 'error');

            let finalTime = `Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª (Ø®Ù„Ø§Ù„ ${deliveryTime} Ø¯Ù‚ÙŠÙ‚Ø©)`;
            if (document.querySelector('input[name="pickup-time-type"]:checked').value === 'scheduled') {
                finalTime = `Ø§Ù„Ø³Ø§Ø¹Ø© ${document.getElementById('scheduled-time-select').value}`;
            }

            const pNotes = document.getElementById('pickup-notes').value.trim();

            let text = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±ÙƒØ© ğŸ—*\n`;
            text += `ğŸ”´ *Ø·Ù„Ø¨ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹*\n`;
            text += `ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${custName}\n`;
            text += `ğŸ“ Ø§Ù„ÙØ±Ø¹: ${branch}\n`;
            text += `â±ï¸ ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: *${finalTime}*\n`;
            if(pNotes) text += `ğŸš— Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ù„Ø³ÙŠØ§Ø±Ø©): ${pNotes}\n`;
            text += `\n-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ --\n`;
            
            cart.forEach(i => {
                text += `â–ªï¸ *${i.name}* (Ø§Ù„Ø¹Ø¯Ø¯: ${i.qty})\n`;
                if(i.flv) text += `   - Ø§Ù„Ø·Ø¹Ù…: ${i.flv}\n`;
                if(i.cheeseInfo) text += `   - Ø§Ù„Ø¬Ø¨Ù†: ${i.cheeseInfo}\n`;
                if(i.sauces.length) text += `   - ØµÙˆØµ: ${i.sauces.join('ØŒ ')}\n`;
                if(i.drinks.length) text += `   - Ù…Ø´Ø±ÙˆØ¨: ${i.drinks.join('ØŒ ')}\n`;
                if(i.note) text += `   - Ù…Ù„Ø§Ø­Ø¸Ø©: ${i.note}\n`;
                text += `   - Ø§Ù„Ø³Ø¹Ø±: ${i.totalPrice.toFixed(3)} Ø±.Ø¹\n\n`;
            });
            text += `====================\nğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${document.getElementById('total-val').innerText} Ø±.Ø¹*\n====================`;
            
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨... ğŸš€');
            setTimeout(() => {
                window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(text)}`);
            }, 1000);
        }

        // Init
        fetchMenuData();
    </script>
</body>
</html>
